<modification>
	<name>SEO Backpack by iSenseLabs</name>
	<version>2.10.1</version>
	<link>http://isenselabs.com</link>
	<author>iSenseLabs</author>
	<code>isense_seo_pack</code>
    	
	<file path="admin/controller/catalog/product.php">
	    <operation error="skip">
			<search><![CDATA[
			$data['stores'] = $this->model_setting_store->getStores();
			]]></search>
			<add position="after"><![CDATA[
			$this->config->load('isenselabs/isenselabs_seo');
			$seo_model_loader = $this->config->get('isenselabs_seo_model');
			$seo_module_path = $this->config->get('isenselabs_seo_path');
			$this->load->model($seo_module_path);
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			$data['keyword'] = $product_info['keyword'];
			]]></search>
			<add position="replace"><![CDATA[
			$data['keyword'] = $this->{$seo_model_loader}->getKeywords($this->request->get['product_id'], 'product');
			]]></add>
		</operation>
			
		<operation error="skip">
			<search><![CDATA[
			$data['keyword'] = '';
			]]></search>
			<add position="replace"><![CDATA[
			$data['keyword'] = array();
			]]></add>
		</operation>
		
		<operation error="skip">
			<search position="replace"><![CDATA[
			getUrlAlias($this->request->post['keyword'])
			]]></search>
			<add><![CDATA[
			getUrlAlias(reset($this->request->post['keyword']))
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			utf8_strlen($this->request->post['keyword'])
			]]></search>
			<add position="replace"><![CDATA[
			utf8_strlen(reset($this->request->post['keyword']))
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			if (isset($this->request->post['keyword'])) {
			]]></search>
			<add position="before"><![CDATA[
			if (isset($this->request->post['h1'])) {
                $data['h1'] = $this->request->post['h1'];
            } elseif (!empty($product_info)) {
                $data['h1'] = $this->{$seo_model_loader}->getH1Tags($this->request->get['product_id']);
            } else {
                $data['h1'] = array();
            }
            
            if (isset($this->request->post['h2'])) {
                $data['h2'] = $this->request->post['h2'];
            } elseif (!empty($product_info)) {
                $data['h2'] = $this->{$seo_model_loader}->getH2Tags($this->request->get['product_id']);
            } else {
                $data['h2'] = array();
            }
			]]></add>
		</operation>
	</file>
	
	<file path="admin/model/catalog/product.php">
        <operation error="skip">
			<search><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id . "'");
			]]></search>
			<add position="replace"><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "seo_url_alias WHERE query = 'product_id=" . (int)$product_id . "'");
			
			$this->db->query("DELETE FROM " . DB_PREFIX . "seo_product_description WHERE product_id='" . (int)$product_id . "'");
			]]></add>
		</operation>
    
	    <operation error="skip">
			<search><![CDATA[
			$data['keyword'] = '';
			]]></search>
			<add position="replace"><![CDATA[
			$data['keyword'] = array();
			
			$data['h1'] = array();
			$data['h2'] = array();
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id . "') AS keyword
			]]></search>
			<add position="replace"><![CDATA[
			, (SELECT keyword FROM " . DB_PREFIX . "seo_url_alias WHERE query = 'product_id=" . (int)$product_id . "' and language_id=" . $this->config->get('config_language_id') . " LIMIT 1) AS keyword
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			$this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'product_id=" . (int)$product_id . "', keyword = '" . $this->db->escape($data['keyword']) . "'");
			]]></search>
			<add position="replace"><![CDATA[
			if (!empty($data['keyword']) && is_array($data['keyword'])) {
                $this->config->load('isenselabs/isenselabs_seo');
                $seo_model_loader = $this->config->get('isenselabs_seo_model');
                $seo_module_path = $this->config->get('isenselabs_seo_path');
                $this->load->model($seo_module_path);

                foreach ($data['keyword'] as $language_id => $keyword) {
                    if (!empty($keyword)) {
                        $this->db->query("INSERT INTO `" . DB_PREFIX . "seo_url_alias` SET `query` = 'product_id=" . (int)$product_id . "', `keyword` = '" . $this->db->escape($keyword) . "', `language_id` = " . $this->db->escape($language_id) . "");
                    } else {
                       $autogenerate = $this->{$seo_model_loader}->getSetting('url_product_autogenerate');
                       if ($autogenerate) {
                           $url_create = $this->{$seo_model_loader}->SeoProductURLs(array(array('product_id' => $product_id)), $language_id);
                       }
                    }
                }
            } else {
            }
            ]]></add>
		</operation>

		<operation error="skip">
			<search><![CDATA[
			if (isset($data['product_recurring'])) {
			]]></search>
			<add position="before"><![CDATA[
			if (!empty($data['h1'])) {
                foreach ($data['h1'] as $lang_id => $h1) {
                    if (!empty($h1)) {
                        $data_checker = $this->db->query("SELECT `product_id` FROM `" . DB_PREFIX . "seo_product_description` WHERE product_id='" . (int)$product_id . "' AND `language_id` = '" . $this->db->escape($lang_id) . "'");

                        if ($data_checker->num_rows == 0) {
                            $this->db->query("INSERT INTO `" . DB_PREFIX . "seo_product_description` SET product_id='" . (int)$product_id . "', `h1` = '" . $this->db->escape($h1) . "', `language_id` = " . $this->db->escape($lang_id) . "");
                        } else {
                            $this->db->query("UPDATE `" . DB_PREFIX . "seo_product_description` SET `h1` = '" . $this->db->escape($h1) . "' WHERE product_id='" . (int)$product_id . "' AND `language_id` = '" . $this->db->escape($lang_id) . "'");
                        }

                    }
                }
			}
			
			if (!empty($data['h2'])) {
                foreach ($data['h2'] as $lang_id => $h2) {
                    if (!empty($h2)) {
                        $data_checker = $this->db->query("SELECT `product_id` FROM `" . DB_PREFIX . "seo_product_description` WHERE product_id='" . (int)$product_id . "' AND `language_id` = '" . $this->db->escape($lang_id) . "'");

                        if ($data_checker->num_rows == 0) {
                            $this->db->query("INSERT INTO `" . DB_PREFIX . "seo_product_description` SET product_id='" . (int)$product_id . "', `h2` = '" . $this->db->escape($h2) . "', `language_id` = " . $this->db->escape($lang_id) . "");
                        } else {
                            $this->db->query("UPDATE `" . DB_PREFIX . "seo_product_description` SET `h2` = '" . $this->db->escape($h2) . "' WHERE product_id='" . (int)$product_id . "' AND `language_id` = '" . $this->db->escape($lang_id) . "'");
                        }
                    }
                }
			}
			]]></add>
		</operation>
	</file>	
	
	<file path="admin/model/catalog/url_alias.php">
        <operation error="skip">
            <search><![CDATA[
            $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE keyword = '" . $this->db->escape($keyword) . "'");
            ]]></search>
            <add position="replace"><![CDATA[
            $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "seo_url_alias WHERE keyword = '" . $this->db->escape($keyword) . "'");
            ]]></add>
        </operation>
    </file>
	
	<file path="admin/view/template/catalog/product_form.tpl">
		<operation error="skip">
			<search><![CDATA[
			<input type="text" name="keyword" value="<?php echo $keyword; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
			]]></search>
			<add position="replace"><![CDATA[
            <?php foreach ($languages as $language_seo) { ?>
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language_seo['code']; ?>/<?php echo $language_seo['code']; ?>.png" alt="<?php echo $language_seo['name']; ?>" title="<?php echo $language_seo['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language_seo['image']; ?>" alt="<?php echo $language_seo['name']; ?>" title="<?php echo $language_seo['name']; ?>" />
                    <?php } ?>
                    </div>
                    <input type="text" class="form-control" name="keyword[<?php echo $language_seo['language_id']; ?>]" value="<?php echo (isset($keyword[$language_seo['language_id']])) ? $keyword[$language_seo['language_id']] : ''; ?>" />
                </div>
            </div>               
            <?php } ?>              
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			<label class="col-sm-2 control-label" for="input-meta-title<?php echo $language['language_id']; ?>"><?php echo $entry_meta_title; ?></label>
			]]></search>
			<add position="before"><![CDATA[
                <label class="col-sm-2 control-label" for="input-h1<?php echo $language['language_id']; ?>">H1 Tag:</label>
                <div class="col-sm-10">
                  <input type="text" name="h1[<?php echo $language['language_id']; ?>]" value="<?php echo isset($h1[$language['language_id']]) ? $h1[$language['language_id']] : ''; ?>" placeholder="H1 Tag" id="input-h1<?php echo $language['language_id']; ?>" class="form-control" />
                </div>
              </div>
              <div class="form-group">
              <label class="col-sm-2 control-label" for="input-h2<?php echo $language['language_id']; ?>">H2 Tag:</label>
                <div class="col-sm-10">
                  <input type="text" name="h2[<?php echo $language['language_id']; ?>]" value="<?php echo isset($h2[$language['language_id']]) ? $h2[$language['language_id']] : ''; ?>" placeholder="H2 Tag" id="input-h2<?php echo $language['language_id']; ?>" class="form-control" />
                </div>
              </div>
              <div class="form-group required">
			]]></add>
		</operation>						
	</file>
	
	<file path="admin/controller/catalog/category.php">
		<operation error="skip">
			<search><![CDATA[
			$data['keyword'] = $category_info['keyword'];
			]]></search>
			<add position="replace"><![CDATA[
			$this->config->load('isenselabs/isenselabs_seo');
			$seo_model_loader = $this->config->get('isenselabs_seo_model');
			$seo_module_path = $this->config->get('isenselabs_seo_path');
			$this->load->model($seo_module_path);
			$data['keyword'] = $this->{$seo_model_loader}->getKeywords($this->request->get['category_id'], 'category');
			]]></add>
		</operation>
			
		<operation error="skip">
			<search><![CDATA[
			$data['keyword'] = '';
			]]></search>
			<add position="replace"><![CDATA[
			$data['keyword'] = array();
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			getUrlAlias($this->request->post['keyword'])
			]]></search>
			<add position="replace"><![CDATA[
			getUrlAlias(reset($this->request->post['keyword']))
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			utf8_strlen($this->request->post['keyword'])
			]]></search>
			<add position="replace"><![CDATA[
			utf8_strlen(reset($this->request->post['keyword']))
			]]></add>
		</operation>	
	</file>
	
	<file path="admin/model/catalog/category.php">
	    <operation error="skip">
			<search><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id . "'");
			]]></search>
			<add position="replace"><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "seo_url_alias WHERE query = 'category_id=" . (int)$category_id . "'");
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			$this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'category_id=" . (int)$category_id . "', keyword = '" . $this->db->escape($data['keyword']) . "'");
			]]></search>
			<add position="replace"><![CDATA[
			if (!empty($data['keyword']) && is_array($data['keyword'])) {
                $this->config->load('isenselabs/isenselabs_seo');
                $seo_model_loader = $this->config->get('isenselabs_seo_model');
                $seo_module_path = $this->config->get('isenselabs_seo_path');
                $this->load->model($seo_module_path);
			
                foreach ($data['keyword'] as $language_id => $keyword) {
                    if (!empty($keyword)) {
                        $this->db->query("INSERT INTO `" . DB_PREFIX . "seo_url_alias` SET `query` = 'category_id=" . (int)$category_id . "', `keyword` = '" . $this->db->escape($keyword) . "', `language_id` = " . $this->db->escape($language_id) . "");
                    } else {
                        $autogenerate = $this->{$seo_model_loader}->getSetting('url_category_autogenerate');
                        if ($autogenerate) {
                            $url_create = $this->{$seo_model_loader}->SeoCategoryURLs(array(array('category_id' => $category_id)), $language_id);
                        }
                    }
                }
			}
			]]></add>
		</operation>
					
		<operation error="skip">
			<search><![CDATA[
			, (SELECT DISTINCT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'category_id=" . (int)$category_id . "') AS keyword
			]]></search>
			<add position="replace"><![CDATA[, (SELECT DISTINCT keyword FROM " . DB_PREFIX . "seo_url_alias WHERE query = 'category_id=" . (int)$category_id . "' and language_id=" . $this->config->get('config_language_id') . ") AS keyword]]></add>
		</operation>	
	</file>	
	
	<file path="admin/view/template/catalog/category_form.tpl">
		<operation error="skip">
			<search><![CDATA[
			<input type="text" name="keyword" value="<?php echo $keyword; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />]]></search>
			<add position="replace"><![CDATA[
			<?php foreach ($languages as $language) { ?>
			<div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <input type="text" name="keyword[<?php echo $language['language_id']; ?>]" value="<?php echo (isset($keyword[$language['language_id']])) ? $keyword[$language['language_id']] : ''; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
                </div>
            </div>  
			<?php } ?>
			]]></add>
		</operation>			
	</file>
	
	<file path="admin/controller/catalog/manufacturer.php">
		<operation error="skip">
			<search><![CDATA[
			$data['keyword'] = $manufacturer_info['keyword'];
			]]></search>
			<add position="replace"><![CDATA[
			$this->config->load('isenselabs/isenselabs_seo');
			$seo_model_loader = $this->config->get('isenselabs_seo_model');
			$seo_module_path = $this->config->get('isenselabs_seo_path');
			$this->load->model($seo_module_path);
			$data['keyword'] = $this->{$seo_model_loader}->getKeywords($this->request->get['manufacturer_id'], 'manufacturer');
			]]></add>
		</operation>
			
		<operation error="skip">
			<search><![CDATA[
			$data['keyword'] = '';
			]]></search>
			<add position="replace"><![CDATA[
			$data['keyword'] = array();
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			protected function getForm() {
			]]></search>
			<add position="after"><![CDATA[
			$this->load->model('localisation/language');
			$data['languages'] = $this->model_localisation_language->getLanguages();
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			getUrlAlias($this->request->post['keyword'])
			]]></search>
			<add position="replace"><![CDATA[
			getUrlAlias(reset($this->request->post['keyword']))
			]]></add>
		</operation>	
		
		<operation error="skip">
			<search><![CDATA[
			utf8_strlen($this->request->post['keyword'])
			]]></search>
			<add position="replace"><![CDATA[
			utf8_strlen(reset($this->request->post['keyword']))
			]]></add>
		</operation>
	</file>
	
	<file path="admin/model/catalog/manufacturer.php">
		<operation error="skip">
			<search><![CDATA[
			$manufacturer_id = $this->db->getLastId();
			]]></search>
			<add position="after"><![CDATA[
            $this->load->model('localisation/language');
            $languages = $this->model_localisation_language->getLanguages();

            foreach ($languages as $language) {
                $this->db->query("INSERT INTO `" . DB_PREFIX . "seo_manufacturer_description` SET `manufacturer_id` = '" . $manufacturer_id . "', `language_id` = '" . $language['language_id'] . "'");
            }
			]]></add>
		</operation>
   
        <operation error="skip">
			<search><![CDATA[
			$this->db->query("UPDATE " . DB_PREFIX . "manufacturer SET name = '" . $this->db->escape($data['name']) . "', sort_order = '" . (int)$data['sort_order'] . "' WHERE manufacturer_id = '" . (int)$manufacturer_id . "'");
			]]></search>
			<add position="after"><![CDATA[
            $this->load->model('localisation/language');
            $languages = $this->model_localisation_language->getLanguages();

            foreach ($languages as $language) {
                $query_check = $this->db->query("SELECT * FROM `" . DB_PREFIX . "seo_manufacturer_description` WHERE `manufacturer_id` = '" . $manufacturer_id . "'")->num_rows;
                
                if ($query_check == 0) {
                    $this->db->query("INSERT INTO `" . DB_PREFIX . "seo_manufacturer_description` SET `manufacturer_id` = '" . $manufacturer_id . "', `language_id` = '" . $language['language_id'] . "'");
                }
            }
			]]></add>
		</operation>
            
	    <operation error="skip">
			<search><![CDATA[
			public function deleteManufacturer($manufacturer_id) {
			]]></search>
			<add position="after"><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "seo_manufacturer_description WHERE manufacturer_id= '" . (int)$manufacturer_id . "'");
			]]></add>
		</operation>
	
	    <operation error="skip">
			<search position="replace"><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'manufacturer_id=" . (int)$manufacturer_id . "'");
			]]></search>
			<add><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "seo_url_alias WHERE query = 'manufacturer_id=" . (int)$manufacturer_id . "'");
			]]></add>
		</operation>
		
		<operation error="skip">
			<search position="replace"><![CDATA[
			$this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'manufacturer_id=" . (int)$manufacturer_id . "', keyword = '" . $this->db->escape($data['keyword']) . "'");
			]]></search>
			<add><![CDATA[
			if (!empty($data['keyword']) && is_array($data['keyword'])) {
                $this->config->load('isenselabs/isenselabs_seo');
                $seo_model_loader = $this->config->get('isenselabs_seo_model');
                $seo_module_path = $this->config->get('isenselabs_seo_path');
                $this->load->model($seo_module_path);
			
                foreach ($data['keyword'] as $language_id => $keyword) {
                    if (!empty($keyword)) {
                        $this->db->query("INSERT INTO `" . DB_PREFIX . "seo_url_alias` SET `query` = 'manufacturer_id=" . (int)$manufacturer_id . "', `keyword` = '" . $this->db->escape($keyword) . "', `language_id` = " . $language_id);
                    } else {
                        $autogenerate = $this->{$seo_model_loader}->getSetting('url_manufacturer_autogenerate');
                        if ($autogenerate) {
                           $url_create = $this->{$seo_model_loader}->SeoManufacturerURLs(array(array('manufacturer_id' => $manufacturer_id)), $language_id);
                        }
                    }
                }
			}
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'manufacturer_id=" . (int)$manufacturer_id . "') AS keyword
			]]></search>
			<add position="replace"><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "seo_url_alias WHERE query = 'manufacturer_id=" . (int)$manufacturer_id . "' and language_id=" . $this->config->get('config_language_id') . " LIMIT 1) AS keyword]]></add>
		</operation>			
	</file>	
	
	<file path="admin/view/template/catalog/manufacturer_form.tpl">
		<operation error="skip">
			<search><![CDATA[
			<input type="text" name="keyword" value="<?php echo $keyword; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
			]]></search>
			<add position="replace"><![CDATA[
			<?php foreach ($languages as $language) { ?>
			<div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <input type="text" name="keyword[<?php echo $language['language_id']; ?>]" value="<?php echo (isset($keyword[$language['language_id']])) ? $keyword[$language['language_id']] : ''; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
                </div>
            </div>		 
			<?php } ?>
			]]></add>
		</operation>			
	</file>
	
	<file path="admin/controller/catalog/information.php">
		<operation error="skip">
			<search><![CDATA[
			$data['keyword'] = $information_info['keyword'];
			]]></search>
			<add position="replace"><![CDATA[
			$this->config->load('isenselabs/isenselabs_seo');
			$seo_model_loader = $this->config->get('isenselabs_seo_model');
			$seo_module_path = $this->config->get('isenselabs_seo_path');
			$this->load->model($seo_module_path);
			$data['keyword'] = $this->{$seo_model_loader}->getKeywords($this->request->get['information_id'], 'information');
			]]></add>
		</operation>	
		
		<operation error="skip">
			<search><![CDATA[
			$data['keyword'] = '';
			]]></search>
			<add position="replace"><![CDATA[
			$data['keyword'] = array();
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			getUrlAlias($this->request->post['keyword'])
			]]></search>
			<add position="replace"><![CDATA[
			getUrlAlias(reset($this->request->post['keyword']))
			]]></add>
		</operation>	
		
		<operation error="skip">
			<search><![CDATA[
			utf8_strlen($this->request->post['keyword'])
			]]></search>
			<add position="replace"><![CDATA[
			utf8_strlen(reset($this->request->post['keyword']))
			]]></add>
		</operation>
	</file>
	
	<file path="admin/model/catalog/information.php">
	    <operation error="skip">
			<search><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'information_id=" . (int)$information_id . "'");
			]]></search>
			<add position="replace"><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "seo_url_alias WHERE query = 'information_id=" . (int)$information_id . "'");
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			$this->db->query("INSERT INTO " . DB_PREFIX . "url_alias SET query = 'information_id=" . (int)$information_id . "', keyword = '" . $this->db->escape($data['keyword']) . "'");
			]]></search>
			<add position="replace"><![CDATA[
            if (!empty($data['keyword']) && is_array($data['keyword'])) {
                $this->config->load('isenselabs/isenselabs_seo');
                $seo_model_loader = $this->config->get('isenselabs_seo_model');
                $seo_module_path = $this->config->get('isenselabs_seo_path');
                $this->load->model($seo_module_path);
			
                foreach ($data['keyword'] as $language_id => $keyword) {
                    if (!empty($keyword)) {
                        $this->db->query("INSERT INTO `" . DB_PREFIX . "seo_url_alias` SET `query` = 'information_id=" . (int)$information_id . "', `keyword` = '" . $this->db->escape($keyword) . "', `language_id` = " . $language_id);    
                    } else {
                        $autogenerate = $this->{$seo_model_loader}->getSetting('url_information_autogenerate');
                        if ($autogenerate) {
                            $url_create = $this->{$seo_model_loader}->SeoInformationURLs(array(array('information_id' => $information_id)), $language_id);
                        }
                    }
                }
			}
			]]></add>
		</operation>
		
		<operation error="skip">
			<search position="replace"><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'information_id=" . (int)$information_id . "') AS keyword]]></search>
			<add><![CDATA[, (SELECT keyword FROM " . DB_PREFIX . "seo_url_alias WHERE query = 'information_id=" . (int)$information_id . "'  and language_id=" . $this->config->get('config_language_id') . " LIMIT 1) AS keyword]]></add>
		</operation>
	</file>
	
	<file path="admin/view/template/catalog/information_form.tpl">
		<operation error="skip">
			<search><![CDATA[
			<input type="text" name="keyword" value="<?php echo $keyword; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
			]]></search>
			<add position="replace"><![CDATA[
			<?php foreach ($languages as $language) { ?>
			<div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <input type="text" name="keyword[<?php echo $language['language_id']; ?>]" value="<?php echo (isset($keyword[$language['language_id']])) ? $keyword[$language['language_id']] : ''; ?>" placeholder="<?php echo $entry_keyword; ?>" id="input-keyword" class="form-control" />
                </div>
            </div>		
			<?php } ?>
			]]></add>
		</operation>			
	</file>	
	
	<file path="admin/view/template/setting/setting.tpl">
		<operation error="skip">
			<search><![CDATA[
            <input type="text" name="config_meta_title" value="<?php echo $config_meta_title; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title" class="form-control" />
			]]></search>
			<add position="replace"><![CDATA[
            <?php foreach ($languages as $language) { ?>
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <input type="text" name="config_meta_title[<?php echo $language['language_id']; ?>]" value="<?php echo (is_array($config_meta_title) && isset($config_meta_title[$language['language_id']])) ? $config_meta_title[$language['language_id']] : $config_meta_title; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title" class="form-control" />
                </div>
            </div>
            <?php } ?>
			]]></add>
		</operation>
      
     	<operation error="skip">
			<search><![CDATA[
			<textarea name="config_meta_description" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description" class="form-control"><?php echo $config_meta_description; ?></textarea>
			]]></search>
			<add position="replace"><![CDATA[
            <?php foreach ($languages as $language) { ?>
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <textarea name="config_meta_description[<?php echo $language['language_id']; ?>]" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description" class="form-control"><?php echo (is_array($config_meta_description) && isset($config_meta_description[$language['language_id']])) ? $config_meta_description[$language['language_id']] : $config_meta_description; ?></textarea>
                </div>
            </div>
            <?php } ?>
			]]></add>
		</operation>
      
		<operation error="skip">
			<search><![CDATA[
			<textarea name="config_meta_keyword" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword" class="form-control"><?php echo $config_meta_keyword; ?></textarea>
			]]></search>
			<add position="replace"><![CDATA[
            <?php foreach ($languages as $language) { ?>
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <textarea name="config_meta_keyword[<?php echo $language['language_id']; ?>]" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword" class="form-control"><?php echo (is_array($config_meta_keyword) && isset($config_meta_keyword[$language['language_id']])) ? $config_meta_keyword[$language['language_id']] : $config_meta_keyword; ?></textarea>
                </div>
            </div>   
            <?php } ?>
			]]></add>
		</operation>	
	</file>
       
    <file path="admin/view/template/setting/store_form.tpl">
		<operation error="skip">
			<search><![CDATA[
            <input type="text" name="config_meta_title" value="<?php echo $config_meta_title; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title" class="form-control" />
			]]></search>
			<add position="replace"><![CDATA[
            <?php foreach ($languages as $language) { ?>
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <input type="text" name="config_meta_title[<?php echo $language['language_id']; ?>]" value="<?php echo (is_array($config_meta_title) && isset($config_meta_title[$language['language_id']])) ? $config_meta_title[$language['language_id']] : $config_meta_title; ?>" placeholder="<?php echo $entry_meta_title; ?>" id="input-meta-title" class="form-control" />
                </div>
            </div>
            <?php } ?>
			]]></add>
		</operation>
      
     	<operation error="skip">
			<search><![CDATA[
			<textarea name="config_meta_description" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description" class="form-control"><?php echo $config_meta_description; ?></textarea>
			]]></search>
			<add position="replace"><![CDATA[
            <?php foreach ($languages as $language) { ?>
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <textarea name="config_meta_description[<?php echo $language['language_id']; ?>]" rows="5" placeholder="<?php echo $entry_meta_description; ?>" id="input-meta-description" class="form-control"><?php echo (is_array($config_meta_description) && isset($config_meta_description[$language['language_id']])) ? $config_meta_description[$language['language_id']] : $config_meta_description; ?></textarea>
                </div>
            </div>
            <?php } ?>
			]]></add>
		</operation>
      
		<operation error="skip">
			<search><![CDATA[
			<textarea name="config_meta_keyword" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword" class="form-control"><?php echo $config_meta_keyword; ?></textarea>
			]]></search>
			<add position="replace"><![CDATA[
            <?php foreach ($languages as $language) { ?>
            <div class="form-group">
                <div class="input-group">
                    <div class="input-group-addon">
                    <?php if (VERSION >= '2.2.0.0') { ?>
                        <img src="language/<?php echo $language['code']; ?>/<?php echo $language['code']; ?>.png" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } else { ?>
                        <img src="view/image/flags/<?php echo $language['image']; ?>" alt="<?php echo $language['name']; ?>" title="<?php echo $language['name']; ?>" />
                    <?php } ?>
                    </div>
                    <textarea name="config_meta_keyword[<?php echo $language['language_id']; ?>]" rows="5" placeholder="<?php echo $entry_meta_keyword; ?>" id="input-meta-keyword" class="form-control"><?php echo (is_array($config_meta_keyword) && isset($config_meta_keyword[$language['language_id']])) ? $config_meta_keyword[$language['language_id']] : $config_meta_keyword; ?></textarea>
                </div>
            </div>   
            <?php } ?>
			]]></add>
		</operation>
	</file>
	
	<file path="catalog/controller/common/home.php">
		<operation error="skip">
			<search><![CDATA[
			$this->config->get('config_meta_title')
			]]></search>
			<add position="replace"><![CDATA[
			(is_array($titles) && isset($titles[$this->config->get('config_language_id')])) ? $titles[$this->config->get('config_language_id')] : $titles
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[$this->config->get('config_meta_description')]]></search>
			<add position="replace"><![CDATA[
			(is_array($meta_descriptions) && isset($meta_descriptions[$this->config->get('config_language_id')])) ? $meta_descriptions[$this->config->get('config_language_id')] : $meta_descriptions
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[
			$this->config->get('config_meta_keyword')
			]]></search>
			<add position="replace"><![CDATA[
            (is_array($meta_keywords) && isset($meta_keywords[$this->config->get('config_language_id')])) ? $meta_keywords[$this->config->get('config_language_id')] : $meta_keywords
			]]></add>
		</operation>	
		<operation error="skip">
			<search><![CDATA[$this->document->setTitle]]></search>
			<add position="before"><![CDATA[			
			$titles = $this->config->get('config_meta_title');
			$meta_descriptions = $this->config->get('config_meta_description');
			$meta_keywords = $this->config->get('config_meta_keyword');
			]]></add>
		</operation>				
	</file>	
	
	<file path="catalog/controller/product/product.php">
        <operation error="skip">
			<search><![CDATA[$data['description'] = html_entity_decode($product_info['description'], ENT_QUOTES, 'UTF-8');]]></search>
			<add position="after"><![CDATA[			
			//iSense SEO Module Loader
            $this->config->load('isenselabs/isenselabs_seo');
            $isense_module_path = $this->config->get('isenselabs_seo_path');
            $isense_call_model  = $this->config->get('isenselabs_seo_model');
            $this->load->model($isense_module_path);
            
            $autolinks = $this->{$isense_call_model}->getAutoLinks();
            
            if ($autolinks) {
                $data['description'] = $this->{$isense_call_model}->getDescriptionWithAutolinks($data['description']);
            }
            
            $h1 = $this->{$isense_call_model}->getProductH1Tag($product_id);
            $h2 = $this->{$isense_call_model}->getProductH2Tag($product_id);
            
            $data['description'] = (!empty($h2)) ? '<h2>' . $h2 . '</h2>' . $data['description'] : $data['description'];
            
            $data['heading_title'] = (!empty($h1)) ? $h1 : $product_info['name'];
			]]></add>
		</operation>				
	</file>
	
	<file path="catalog/controller/product/category.php">
        <operation error="skip">
			<search><![CDATA[$data['description'] = html_entity_decode($category_info['description'], ENT_QUOTES, 'UTF-8');]]></search>
			<add position="after"><![CDATA[			
            //iSense SEO Module Loader
            $this->config->load('isenselabs/isenselabs_seo');
            $isense_module_path = $this->config->get('isenselabs_seo_path');
            $isense_call_model  = $this->config->get('isenselabs_seo_model');
            $this->load->model($isense_module_path);
            
            $autolinks = $this->{$isense_call_model}->getAutoLinks();
            
            if ($autolinks) {
                $data['description'] = $this->{$isense_call_model}->getDescriptionWithAutolinks($data['description']);
            }         
			]]></add>
		</operation>				
	</file>
	
	<file path="catalog/controller/startup/seo_url.php">
        <operation error="skip">
			<search><![CDATA[parse_str($url_info['query'], $data);]]></search>
			<add position="after"><![CDATA[			
			
            //iSense SEO Module
            
            //Common Home Fix
            if (isset($data['route']) && $data['route'] == 'common/home') {
            	$is_common_home = true;
			} else {
				$is_common_home = false;
			}

			if ($is_common_home) {
				unset($data['route']);

				$query = '';

				if ($data) {
					foreach ($data as $key => $value) {
						$query .= '&' . rawurlencode((string)$key) . '=' . rawurlencode((is_array($value) ? http_build_query($value) : (string)$value));
					}

					if ($query) {
						$query = '?' . str_replace('&', '&amp;', trim($query, '&'));
					}
				}

				if ($subfolder_check) {
                    $language_string = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "setting` WHERE `key` = 'config_language'")->row['value'];

                    if (isset($this->session->data['language'])) {
                        if($this->session->data['language'] <> $language_string || $default_lang_prefix) {
                            $url_prefix = '/' . $this->session->data['language']. '/';

                            if (!empty($subfolder_prefixes_alias) && isset($subfolder_prefixes_alias[$active_lang_code])) {
                                $url_prefix = '/' . $subfolder_prefixes_alias[$active_lang_code] . '/';
                            }
                        }
                        else {
                        	$url_prefix = '';
                        }
                    } else {
                        $url_prefix = '';
                    }

                   return $url_info['scheme'] . '://' . $url_info['host'] . (isset($url_info['port']) ? ':' . $url_info['port'] : '') . str_replace('/index.php', '', $url_info['path']) . $url_prefix . $url . $query;
               } else {
                   $new_link = $url_info['scheme'] . '://' . $url_info['host'] . (isset($url_info['port']) ? ':' . $url_info['port'] : '') . str_replace('/index.php', '', $url_info['path']) . $url . $query;
                   return $new_link;
               }
			}
            
            //Custom URLs
            $custom_seo_urls = $this->db->query("SELECT * FROM `" . DB_PREFIX . "seo_custom_urls` WHERE `query` = '" . $this->db->escape($data['route']) . "' AND `language_id` = '" . $this->config->get('config_language_id') . "' LIMIT 1");
                
            if ($custom_seo_urls->num_rows > 0) {
                $url .= '/' . $custom_seo_urls->row['keyword'];    
                unset($data['key']);
            }
			]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[foreach ($parts as $part) {]]></search>
			<add position="after"><![CDATA[			
			
            //iSense SEO Module
            //Custom URLs
            $custom_seo_urls = $this->db->query("SELECT * FROM `" . DB_PREFIX . "seo_custom_urls` WHERE `keyword` = '" . $this->db->escape($part) . "' AND `language_id` = '" . $this->config->get('config_language_id') . "' LIMIT 1");
                
            if ($custom_seo_urls->num_rows > 0) {
                $this->request->get['route'] = $custom_seo_urls->row['query'];
				break;
            } else {
                    $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "seo_custom_urls WHERE keyword = '" . $this->db->escape($part) . "' LIMIT 1");

                    if ($query->num_rows > 0) {

                        $base = '';
                
                        $lang_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "language` WHERE `language_id` = '" . $this->db->escape($query->row['language_id']) . "' LIMIT 1");
                        if ($lang_query->num_rows > 0) {
                            $this->session->data['language'] = $lang_query->row['code'];
                            $this->config->set('config_language', $lang_query->row['code']);
                            $this->config->set('config_language_id', $lang_query->row['language_id']);

                            if (isset($_SERVER['HTTPS']) && (($_SERVER['HTTPS'] == 'on') || ($_SERVER['HTTPS'] == '1'))) {
                                $base = HTTPS_SERVER;
                            } else {
                                $base = HTTP_SERVER;
                            } 
                        }
                        
                       
                        
                        $custom_query = $query->row['query'];
                        $custom_lang = $this->config->get('config_language_id');
                        $custom_url_query = $this->db->query("SELECT `keyword` FROM " . DB_PREFIX . "seo_custom_urls WHERE query = '" . $this->db->escape($custom_query) . "' AND language_id = '". (int)$custom_lang ."' LIMIT 1");
                        
                        $lang_prefix  = '';
                        if ($subfolder_check) {
                            $language_string = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "setting` WHERE `key` = 'config_language'")->row['value'];
                            if ($this->config->get('config_language') != $language_string || $default_lang_prefix) {
                                $lang_prefix = $this->config->get('config_language') . '/';

                                if (!empty($active_lang_prefix)) {
                                    $lang_prefix = $active_lang_prefix . '/';
                                }
                            }
                        }

                        
                        $custom_url = $base . $lang_prefix . $custom_url_query->row['keyword'];
                        if (!empty($custom_url)){
                            $this->response->redirect($custom_url);
                        }

                    }
                }
			]]></add>
		</operation>
		
		<operation error="skip">
			<search position="replace"><![CDATA[url_alias WHERE `query`	]]></search>
			<add><![CDATA[seo_url_alias WHERE language_id = '" . $this->config->get('config_language_id') . "' AND `query`]]></add>
		</operation>	
		
		<operation error="skip">
			<search position="replace"><![CDATA[$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE keyword = '" . $this->db->escape($part) . "'");]]></search>
			<add><![CDATA[
			if ($subfolder_check) {
			    $query = $this->db->query("SELECT u.query, u.keyword, u.language_id as lang_id, l.code" . ((VERSION >= '2.2.0.0') ? '' : ', l.directory') . " FROM `" . DB_PREFIX . "seo_url_alias` u LEFT JOIN `" . DB_PREFIX . "language` l on (u.language_id = l.language_id) WHERE u.keyword = '" . $this->db->escape($part) . "'");
			} else {
			    $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "seo_url_alias WHERE keyword = '" . $this->db->escape($part) . "'");
			}
			]]></add>
		</operation>	
		
        <operation error="skip">
			<search position="replace"><![CDATA[return $url_info['scheme'] . '://' . $url_info['host'] . (isset($url_info['port']) ? ':' . $url_info['port'] : '') . str_replace('/index.php', '', $url_info['path']) . $url . $query;]]></search>
			<add><![CDATA[
				if ($subfolder_check) {
                    $language_string = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "setting` WHERE `key` = 'config_language'")->row['value'];

                    if (isset($this->session->data['language'])) {
                        if($this->session->data['language'] <> $language_string || $default_lang_prefix) {
                            $url_prefix = '/' . $this->session->data['language'];

                            if (!empty($subfolder_prefixes_alias) && isset($subfolder_prefixes_alias[$active_lang_code])) {
                                $url_prefix = '/' . $subfolder_prefixes_alias[$active_lang_code];
                            }
                        } else {
                        	$url_prefix = '';
                        }
                    } else {
                        $url_prefix = '';
                    }

                   return $url_info['scheme'] . '://' . $url_info['host'] . (isset($url_info['port']) ? ':' . $url_info['port'] : '') . str_replace('/index.php', '', $url_info['path']) . $url_prefix . $url . $query;
               } else {
                   return $url_info['scheme'] . '://' . $url_info['host'] . (isset($url_info['port']) ? ':' . $url_info['port'] : '') . str_replace('/index.php', '', $url_info['path']) . $url . $query;
               }
            ]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[if (isset($this->request->get['_route_'])) {]]></search>
			<add position="before"><![CDATA[
                if ($subfolder_check) {
                    $lquery = $this->db->query("SELECT * FROM " . DB_PREFIX . "language;");
                    $lparts = isset($this->request->get['_route_']) ? explode('/', $this->request->get['_route_']) : array();
                    $lcode  = isset($lparts[0]) ? $lparts[0] : '';

                    $default_lang_code  = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "setting` WHERE `key` = 'config_language'")->row['value'];
                    $active_lang_prefix = $active_lang_code = isset($this->session->data['language']) ? $this->session->data['language'] : $default_lang_code;
                    $subfolder_prefixes_alias = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = '" . $this->db->escape('subfolder_prefixes_alias'). "' LIMIT 1");
                    $subfolder_prefixes_alias = json_decode($subfolder_prefixes_alias->row['value'], true);
                    
                    if (in_array($lcode, $subfolder_prefixes_alias)) {
                        $active_lang_prefix = $active_lang_code = array_search($lcode, $subfolder_prefixes_alias);
                    }
                    if (isset($subfolder_prefixes_alias[$active_lang_prefix])) {
                        $active_lang_prefix = $subfolder_prefixes_alias[$active_lang_prefix];
                    }

                    if ($default_lang_prefix) {
                        $table_check = $this->db->query("SHOW TABLES LIKE '" . DB_PREFIX ."seo_module_settings'")->num_rows;

                        if ($table_check) {
                            $redirect_active_lang_prefix_query = $this->db->query("SELECT `id` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = 'redirect_active_lang_prefix' AND `value` = '1' LIMIT 1")->num_rows;

                            if ($redirect_active_lang_prefix_query) {
                                if (isset($this->request->get['_route_']) || empty($this->request->get)) {
                                    $missing_lang_code = true;
                                    if ($lcode == $active_lang_prefix) {
                                        $missing_lang_code = false;
                                    }

                                    if ($missing_lang_code) {
                                        $base = HTTP_SERVER;
                                        if (isset($_SERVER['HTTPS']) && (($_SERVER['HTTPS'] == 'on') || ($_SERVER['HTTPS'] == '1'))) {
                                            $base = HTTPS_SERVER;
                                        }
                                        
                                        if (isset($this->request->get['_route_'])) {
                                            $this->response->redirect($base . $active_lang_prefix . '/' . $this->request->get['_route_']);
                                        } else {
                                            $this->response->redirect($base . $active_lang_prefix . '/');
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (isset($this->request->get['_route_'])) {
                        foreach ($lquery->rows as $language) {
                            if ($language['code'] == $active_lang_code) {
                                $this->session->data['language'] = $language['code']; 
                                
                                $this->language = new Language((VERSION >= '2.2.0.0') ? $language['code'] : $language['directory']);
                                $this->language->load((VERSION >= '2.2.0.0') ? $language['code'] : $language['directory']); 

                                $this->registry->set('language', $this->language); 
                                $this->config->set('config_language_id', $language['language_id']); 	

                                if ($default_lang_prefix || $default_lang_code != $active_lang_code) {
                                    $this->request->get['_route_'] = substr($this->request->get['_route_'], strlen($active_lang_prefix . '/'));
                                }
                            }
                        }
                    }
                }
            ]]></add>
		</operation>
		
		<operation error="skip">
			<search><![CDATA[if ($url) {]]></search>
			<add position="replace"><![CDATA[if (($url) && ($url <> '/'.$this->session->data['language'])){]]></add>
		</operation>	
		
		<operation error="skip">
			<search><![CDATA[
			public function index() {
			]]></search>
			<add position="after"><![CDATA[
			$table_check_subfolders = $this->db->query("SHOW TABLES LIKE '" . DB_PREFIX ."seo_module_settings'")->num_rows;
			
			if ($table_check_subfolders) {
                $subfolder_check = $this->db->query("SELECT `id` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = 'subfolder_prefixes' AND `value` = '1' LIMIT 1")->num_rows;
            
			    if ($subfolder_check) {
                    $subfolder_check = true;
                } else {
                    $subfolder_check = false;
                }
			} else {
			    $subfolder_check = false;
			}

			if ($table_check_subfolders) {
                $default_lang_prefix = $this->db->query("SELECT `id` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = 'default_lang_prefix' AND `value` = '1' LIMIT 1")->num_rows;
            
                if ($default_lang_prefix) {
                    $default_lang_prefix = true;
                } else {
                    $default_lang_prefix = false;
                }
            } else {
                $default_lang_prefix = false;
            }
			]]></add>
		</operation>

		<operation error="skip">
			<search><![CDATA[
			public function rewrite($link) {
			]]></search>
			<add position="after"><![CDATA[
			$table_check_subfolders = $this->db->query("SHOW TABLES LIKE '" . DB_PREFIX ."seo_module_settings'")->num_rows;

            if ($table_check_subfolders) {
                $subfolder_check = $this->db->query("SELECT `id` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = 'subfolder_prefixes' AND `value` = '1' LIMIT 1")->num_rows;
            
                if ($subfolder_check) {
                    $subfolder_check = true;
                } else {
                    $subfolder_check = false;
                }
            } else {
                $subfolder_check = false;
            }
			
			if ($table_check_subfolders) {
                $default_lang_prefix = $this->db->query("SELECT `id` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = 'default_lang_prefix' AND `value` = '1' LIMIT 1")->num_rows;
            
			    if ($default_lang_prefix) {
                    $default_lang_prefix = true;
                } else {
                    $default_lang_prefix = false;
                }
			} else {
			    $default_lang_prefix = false;
			}

            if ($subfolder_check) {
                $active_lang_code = isset($this->session->data['language']) ? $this->session->data['language'] : $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "setting` WHERE `key` = 'config_language'")->row['value'];
                $subfolder_prefixes_alias = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = '" . $this->db->escape('subfolder_prefixes_alias'). "' LIMIT 1");
                $subfolder_prefixes_alias = json_decode($subfolder_prefixes_alias->row['value'], true);
            }
			]]></add>
		</operation>

		<operation error="skip">
			<search><![CDATA[
			public function rewrite($link) {
			]]></search>
			<add position="before" offset="2"><![CDATA[
			else {

            $table_check = $this->db->query("SHOW TABLES LIKE '" . DB_PREFIX ."seo_module_settings'")->num_rows;
            
                if ($table_check) {
                    $redirect_to_seo_links_check = $this->db->query("SELECT `id` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = 'redirect_to_seo_links' AND `value` = '1' LIMIT 1")->num_rows;
                
                    if ($redirect_to_seo_links_check) {
                        $redirect_to_seo_links_check = true;
                    } else {
                        $redirect_to_seo_links_check = false;
                    }
                } else {
                    $redirect_to_seo_links_check = false;
                }

            if (isset($this->request->get['route']) && !empty($this->request->get['route']) && $redirect_to_seo_links_check) {
                $request_uri = isset($_SERVER['REQUEST_URI']) && !empty($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '';
                $request_uri_segment = '';
                $request_uri_segment_pos = strpos($request_uri, '&');

                if ($request_uri_segment_pos) {
                    $request_uri_segment = substr($request_uri, $request_uri_segment_pos + 1);
                }
                
                $SEO_link = $this->url->link($this->request->get['route'], $request_uri_segment, 'SSL');
                $isSEOFriendy = strpos($SEO_link, 'route=') ? false : true;
                
                if ($isSEOFriendy){
                    $this->response->redirect($SEO_link);
                }
            }
        }
			]]></add>
		</operation>	
	</file>
	
	<file path="catalog/controller/common/language.php">
        <operation error="skip">
			<search><![CDATA[if (isset($this->request->post['redirect'])) {]]></search>
			<add position="before"><![CDATA[			
            $search_string = "";
            if (($position = strpos($this->request->post['redirect'], "_route_=")) !== FALSE) { 
                $search_string = substr($this->request->post['redirect'], $position+8); 
            }

            if (!empty($search_string)) {
                $search_string = explode('/', urldecode($search_string));

                // remove any empty arrays from trailing
                if (utf8_strlen(end($search_string)) == 0) {
                    array_pop($search_string);
                }

                foreach ($search_string as $string) {
                	$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "seo_custom_urls WHERE keyword = '" . $this->db->escape($string) . "' LIMIT 1");

                	if ($query->num_rows > 0) {
                	
                		if (isset($this->request->post['code'])) {
                            $lang_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "language` WHERE `code` = '" . $this->db->escape($this->request->post['code']) . "' LIMIT 1");
                            if ($lang_query->num_rows > 0) {
                                $this->config->set('config_language', $this->request->post['code']);
                                $this->config->set('config_language_id', $lang_query->row['language_id']);
                            }
                        }
	                    $custom_query = $query->row['query'];
	                    $custom_lang = $this->config->get('config_language_id');
	                    $custom_url_query = $this->db->query("SELECT `keyword` FROM " . DB_PREFIX . "seo_custom_urls WHERE query = '" . $this->db->escape($custom_query) . "'AND language_id = '". $custom_lang ."' LIMIT 1");
	                    $subfolder_prefix_check = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = '" . $this->db->escape('subfolder_prefixes'). "' LIMIT 1");

                        $default_lang_prefix_check = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = '" . $this->db->escape('default_lang_prefix'). "' LIMIT 1");
                        $language_string = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "setting` WHERE `key` = 'config_language'")->row['value'];

                        $lang_prefix  = '';
                        if ($subfolder_prefix_check->row['value']) {
                            if ($this->config->get('config_language') != $language_string || $default_lang_prefix_check->row['value']) {
                                $lang_prefix = $this->config->get('config_language') . '/';

                                $subfolder_prefixes_alias = $this->db->query("SELECT `value` FROM `" . DB_PREFIX . "seo_module_settings` WHERE `key` = '" . $this->db->escape('subfolder_prefixes_alias'). "' LIMIT 1");
                                $subfolder_prefixes_alias = json_decode($subfolder_prefixes_alias->row['value'], true);
                                if (isset($subfolder_prefixes_alias[$this->config->get('config_language')])) {
                                    $lang_prefix = $subfolder_prefixes_alias[$this->config->get('config_language')] . '/';
                                }
                            }
                        }

	                    $custom_url = $lang_prefix . $custom_url_query->row['keyword'];
	                    if (!empty($custom_url)){
	                        $this->response->redirect($custom_url);
	                    }

                	} else {

	                    $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "seo_url_alias WHERE keyword = '" . $this->db->escape($string) . "' LIMIT 1");
	                    $redirect_url = "";
	                    $redirect_path = "";
	                    $redirect_query = "";
	                    
	                    if ($query->num_rows > 0) {
	                        $url = explode('=', $query->row['query']);

	                        if (isset($this->request->post['code'])) {
	                            $lang_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "language` WHERE `code` = '" . $this->db->escape($this->request->post['code']) . "' LIMIT 1");
	                            if ($lang_query->num_rows > 0) {
	                                $this->config->set('config_language', $this->request->post['code']);
	                                $this->config->set('config_language_id', $lang_query->row['language_id']);
	                            }
	                        }

	                        if ($url[0] == 'category_id') {
	                            if (!isset($this->request->get['path'])) {
	                                $this->request->get['path'] = $url[1];
	                            } else {
	                                $this->request->get['path'] .= '_' . $url[1];
	                            }
	                        }
	                        
	                        if ($url[0] == 'product_id') {
	                            $redirect_path = "product/product";
	                            $redirect_query = "product_id=" . $url[1];
	                        }
	                        if ($url[0] == 'manufacturer_id') {
	                            $redirect_path = "product/manufacturer/info";
	                            $redirect_query = "manufacturer_id=" . $url[1];
	                        }
	                        if ($url[0] == 'information_id') {
	                            $redirect_path = "information/information";
	                            $redirect_query = "information_id=" . $url[1];
	                        }
	                    }

                	}
                }

                if (isset($this->request->get['path']) && !empty($redirect_query)) {
                    $redirect_query = "path=" . $this->request->get['path'] . "&" . $redirect_query;
                } else if (isset($this->request->get['path'])) {
                    $redirect_path = "product/category";
                    $redirect_query = "path=" . $this->request->get['path'];
                }
                
                if (!empty($redirect_query) && !empty($redirect_path)) {
                    $redirect_url = $this->url->link($redirect_path, $redirect_query, 'SSL');
                }
                
                if (!empty($redirect_url)) {
                    $this->request->post['redirect'] = $redirect_url;
                } 
            } else {
				if (isset($this->request->post['code'])) {
					$lang_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "language` WHERE `code` = '" . $this->db->escape($this->request->post['code']) . "' LIMIT 1");
					if ($lang_query->num_rows > 0) {
						$this->config->set('config_language', $this->request->post['code']);
						$this->config->set('config_language_id', $lang_query->row['language_id']);

						$this->request->post['redirect'] = $this->url->link('common/home');
					}
				}
			}
			]]></add>
		</operation>
		
	</file>

    <file path="catalog/controller/extension/feed/google_base.php">
        <operation>
            <search><![CDATA[$output .= '  <description>' . $this->config->get('config_meta_description') . '</description>';]]></search>
            <add position="replace"><![CDATA[
                $config_meta_description = $this->config->get('config_meta_description');
                if (is_array($config_meta_description)) {
                    if (isset($config_meta_description[$this->config->get('config_language_id')])) {
                        $meta_description = $config_meta_description[$this->config->get('config_language_id')];
                    } else {
                        $meta_description = '';
                    }
                } else {
                    $meta_description = $config_meta_description;
                }

                $output .= '  <description>' . $meta_description . '</description>';
            ]]></add>
        </operation>
    </file>
  
</modification>
